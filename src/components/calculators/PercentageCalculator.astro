---
import { t, type Locale } from '@/utils/i18n';
import { percentageRegionalConfig, getTaxRates, getCommonDiscounts } from '@/config/percentage-regional';

const { lang } = Astro.props as { lang: Locale };

// Get regional configuration for tax rates and discounts
const config = percentageRegionalConfig[lang] || percentageRegionalConfig.en;
const taxRates = getTaxRates(lang);
const commonDiscounts = getCommonDiscounts(lang);
---

<div class="percentage-calculator">
  <div class="calculator-form">
    <h2>{t('percentage.form.title', lang)}</h2>

    <!-- Calculation Type Selector -->
    <div class="calculation-tabs">
      <button class="tab-btn active" data-type="percentOf">
        {t('percentage.tabs.percentOf', lang)}
      </button>
      <button class="tab-btn" data-type="isWhatPercent">
        {t('percentage.tabs.isWhatPercent', lang)}
      </button>
      <button class="tab-btn" data-type="isPercentOfWhat">
        {t('percentage.tabs.isPercentOfWhat', lang)}
      </button>
      <button class="tab-btn" data-type="percentageChange">
        {t('percentage.tabs.percentageChange', lang)}
      </button>
      <button class="tab-btn" data-type="percentageDifference">
        {t('percentage.tabs.percentageDifference', lang)}
      </button>
      <button class="tab-btn" data-type="addTax">
        {t('percentage.tabs.addTax', lang)}
      </button>
      <button class="tab-btn" data-type="removeTax">
        {t('percentage.tabs.removeTax', lang)}
      </button>
      <button class="tab-btn" data-type="discount">
        {t('percentage.tabs.discount', lang)}
      </button>
      <button class="tab-btn" data-type="reverseDiscount">
        {t('percentage.tabs.reverseDiscount', lang)}
      </button>
    </div>

    <!-- Form 1: What is X% of Y? -->
    <form id="form-percentOf" class="calc-form active">
      <h3>{t('percentage.forms.percentOf.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="percentOf-percent">{t('percentage.forms.percentOf.label1', lang)}</label>
          <input
            type="number"
            id="percentOf-percent"
            name="value1"
            step="0.01"
            required
            placeholder="20"
          />
          <span class="unit">%</span>
        </div>
        <div class="form-group">
          <label for="percentOf-value">{t('percentage.forms.percentOf.label2', lang)}</label>
          <input
            type="number"
            id="percentOf-value"
            name="value2"
            step="0.01"
            required
            placeholder="100"
          />
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 2: X is what % of Y? -->
    <form id="form-isWhatPercent" class="calc-form">
      <h3>{t('percentage.forms.isWhatPercent.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="isWhatPercent-value">{t('percentage.forms.isWhatPercent.label1', lang)}</label>
          <input
            type="number"
            id="isWhatPercent-value"
            name="value1"
            step="0.01"
            required
            placeholder="20"
          />
        </div>
        <div class="form-group">
          <label for="isWhatPercent-total">{t('percentage.forms.isWhatPercent.label2', lang)}</label>
          <input
            type="number"
            id="isWhatPercent-total"
            name="value2"
            step="0.01"
            required
            placeholder="100"
          />
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 3: X is Y% of what? -->
    <form id="form-isPercentOfWhat" class="calc-form">
      <h3>{t('percentage.forms.isPercentOfWhat.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="isPercentOfWhat-value">{t('percentage.forms.isPercentOfWhat.label1', lang)}</label>
          <input
            type="number"
            id="isPercentOfWhat-value"
            name="value1"
            step="0.01"
            required
            placeholder="20"
          />
        </div>
        <div class="form-group">
          <label for="isPercentOfWhat-percent">{t('percentage.forms.isPercentOfWhat.label2', lang)}</label>
          <input
            type="number"
            id="isPercentOfWhat-percent"
            name="value2"
            step="0.01"
            required
            placeholder="50"
          />
          <span class="unit">%</span>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 4: Percentage Change -->
    <form id="form-percentageChange" class="calc-form">
      <h3>{t('percentage.forms.percentageChange.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="percentageChange-old">{t('percentage.forms.percentageChange.label1', lang)}</label>
          <input
            type="number"
            id="percentageChange-old"
            name="value1"
            step="0.01"
            required
            placeholder="100"
          />
        </div>
        <div class="form-group">
          <label for="percentageChange-new">{t('percentage.forms.percentageChange.label2', lang)}</label>
          <input
            type="number"
            id="percentageChange-new"
            name="value2"
            step="0.01"
            required
            placeholder="120"
          />
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 5: Percentage Difference -->
    <form id="form-percentageDifference" class="calc-form">
      <h3>{t('percentage.forms.percentageDifference.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="percentageDifference-value1">{t('percentage.forms.percentageDifference.label1', lang)}</label>
          <input
            type="number"
            id="percentageDifference-value1"
            name="value1"
            step="0.01"
            required
            placeholder="100"
          />
        </div>
        <div class="form-group">
          <label for="percentageDifference-value2">{t('percentage.forms.percentageDifference.label2', lang)}</label>
          <input
            type="number"
            id="percentageDifference-value2"
            name="value2"
            step="0.01"
            required
            placeholder="120"
          />
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 6: Add Tax -->
    <form id="form-addTax" class="calc-form">
      <h3>{t('percentage.forms.addTax.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="addTax-price">{t('percentage.forms.addTax.label1', lang)}</label>
          <input
            type="number"
            id="addTax-price"
            name="value1"
            step="0.01"
            required
            placeholder="100"
          />
        </div>
        <div class="form-group">
          <label for="addTax-rate-select">{t('percentage.forms.addTax.selectLabel', lang)}</label>
          <select id="addTax-rate-select" class="tax-rate-select">
            <option value="">{t('percentage.forms.addTax.customLabel', lang)}</option>
            {taxRates.map((tax) => (
              <option value={tax.rate}>{tax.label} ({tax.rate}%)</option>
            ))}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="addTax-rate">{t('percentage.forms.addTax.label2', lang)}</label>
          <input
            type="number"
            id="addTax-rate"
            name="value2"
            step="0.01"
            required
            placeholder="21"
          />
          <span class="unit">%</span>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 7: Remove Tax -->
    <form id="form-removeTax" class="calc-form">
      <h3>{t('percentage.forms.removeTax.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="removeTax-price">{t('percentage.forms.removeTax.label1', lang)}</label>
          <input
            type="number"
            id="removeTax-price"
            name="value1"
            step="0.01"
            required
            placeholder="121"
          />
        </div>
        <div class="form-group">
          <label for="removeTax-rate-select">{t('percentage.forms.removeTax.selectLabel', lang)}</label>
          <select id="removeTax-rate-select" class="tax-rate-select">
            <option value="">{t('percentage.forms.removeTax.customLabel', lang)}</option>
            {taxRates.map((tax) => (
              <option value={tax.rate}>{tax.label} ({tax.rate}%)</option>
            ))}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="removeTax-rate">{t('percentage.forms.removeTax.label2', lang)}</label>
          <input
            type="number"
            id="removeTax-rate"
            name="value2"
            step="0.01"
            required
            placeholder="21"
          />
          <span class="unit">%</span>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 8: Discount -->
    <form id="form-discount" class="calc-form">
      <h3>{t('percentage.forms.discount.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="discount-price">{t('percentage.forms.discount.label1', lang)}</label>
          <input
            type="number"
            id="discount-price"
            name="value1"
            step="0.01"
            required
            placeholder="100"
          />
        </div>
        <div class="form-group">
          <label for="discount-select">{t('percentage.forms.discount.selectLabel', lang)}</label>
          <select id="discount-select" class="discount-select">
            <option value="">{t('percentage.forms.discount.customLabel', lang)}</option>
            {commonDiscounts.map((discount) => (
              <option value={discount}>{discount}%</option>
            ))}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="discount-rate">{t('percentage.forms.discount.label2', lang)}</label>
          <input
            type="number"
            id="discount-rate"
            name="value2"
            step="0.01"
            required
            placeholder="20"
          />
          <span class="unit">%</span>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>

    <!-- Form 9: Reverse Discount -->
    <form id="form-reverseDiscount" class="calc-form">
      <h3>{t('percentage.forms.reverseDiscount.title', lang)}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="reverseDiscount-price">{t('percentage.forms.reverseDiscount.label1', lang)}</label>
          <input
            type="number"
            id="reverseDiscount-price"
            name="value1"
            step="0.01"
            required
            placeholder="80"
          />
        </div>
        <div class="form-group">
          <label for="reverseDiscount-select">{t('percentage.forms.reverseDiscount.selectLabel', lang)}</label>
          <select id="reverseDiscount-select" class="discount-select">
            <option value="">{t('percentage.forms.reverseDiscount.customLabel', lang)}</option>
            {commonDiscounts.map((discount) => (
              <option value={discount}>{discount}%</option>
            ))}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="reverseDiscount-rate">{t('percentage.forms.reverseDiscount.label2', lang)}</label>
          <input
            type="number"
            id="reverseDiscount-rate"
            name="value2"
            step="0.01"
            required
            placeholder="20"
          />
          <span class="unit">%</span>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">{t('common.calculate', lang)}</button>
        <button type="reset" class="btn-secondary">{t('common.reset', lang)}</button>
      </div>
    </form>
  </div>

  <div class="calculator-results" id="results" style="display: none;" role="region" aria-live="polite" aria-atomic="true">
    <h2>{t('percentage.results.title', lang)}</h2>

    <div class="result-card">
      <h3>{t('percentage.results.resultLabel', lang)}</h3>
      <p class="value" id="result-value">-</p>
      <p class="explanation" id="result-explanation">-</p>
    </div>

    <div class="result-details">
      <h3>{t('percentage.results.formulaLabel', lang)}</h3>
      <p class="formula" id="result-formula">-</p>
    </div>
  </div>

</div>

<style>
  .percentage-calculator {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
  }

  .calculator-form, .calculator-results, .calculator-info {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  h2 {
    margin-top: 0;
    color: #333;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
  }

  h3 {
    color: #555;
    font-size: 1.2rem;
    margin-bottom: 1rem;
  }

  /* Tabs */
  .calculation-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 0.5rem;
  }

  .tab-btn {
    padding: 0.75rem 1rem;
    border: none;
    background: #f5f5f5;
    color: #666;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
    border-bottom: 3px solid transparent;
  }

  .tab-btn:hover {
    background: #e8e8e8;
  }

  .tab-btn.active {
    background: white;
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    font-weight: 500;
  }

  /* Forms */
  .calc-form {
    display: none;
  }

  .calc-form.active {
    display: block;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .form-group {
    position: relative;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #555;
  }

  .form-group input[type="number"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .form-group input[type="number"]:focus {
    border-color: var(--primary-color);
  }

  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    background-color: white;
    cursor: pointer;
  }

  .form-group select:focus {
    border-color: var(--primary-color);
    outline: none;
  }

  .unit {
    position: absolute;
    right: 1rem;
    top: 2.5rem;
    color: #888;
    font-size: 0.9rem;
    pointer-events: none;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn-primary, .btn-secondary {
    flex: 1;
    padding: 0.875rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--primary-color);
    color: white;
  }

  .btn-primary:hover {
    background: #2d6a2f;
  }

  .btn-secondary {
    background: #f5f5f5;
    color: #333;
  }

  .btn-secondary:hover {
    background: #e0e0e0;
  }

  /* Results */
  .result-card {
    text-align: center;
    padding: 2rem;
    background: linear-gradient(135deg, #5568d3 0%, #6a4199 100%);
    color: white;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  .result-card h3 {
    margin: 0 0 1rem 0;
    font-size: 1.2rem;
    color: white;
  }

  .result-card .value {
    font-size: 3rem;
    font-weight: bold;
    margin: 0;
  }

  .result-card .explanation {
    font-size: 1.2rem;
    margin: 1rem 0 0 0;
    opacity: 0.9;
  }

  .result-details {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 4px;
  }

  .result-details h3 {
    margin-top: 0;
    color: #555;
  }

  .formula {
    font-family: 'Courier New', monospace;
    background: white;
    padding: 1rem;
    border-left: 4px solid var(--primary-color);
    margin: 0;
    word-break: break-all;
  }

  /* Info Section */
  .calculator-info {
    background: #f9f9f9;
  }

  .calculator-info p {
    margin-bottom: 1rem;
    line-height: 1.6;
    color: #555;
  }

  .info-section {
    margin-top: 1.5rem;
  }

  .info-section h3 {
    color: #333;
    margin-bottom: 0.5rem;
  }

  .info-section ul {
    list-style: disc;
    padding-left: 1.5rem;
    color: #555;
  }

  .info-section li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  @media (max-width: 768px) {
    .calculation-tabs {
      flex-direction: column;
    }

    .tab-btn {
      width: 100%;
      border-radius: 4px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  import type { PercentageCalculationType, PercentageInput, PercentageResult } from '@/utils/calculators/percentage';
  import { calculatePercentage } from '@/utils/calculators/percentage';

  const tabs = document.querySelectorAll('.tab-btn');
  const forms = document.querySelectorAll('.calc-form');
  const results = document.getElementById('results') as HTMLDivElement;

  let currentType: PercentageCalculationType = 'percentOf';

  // Handle tax rate select dropdowns
  const taxSelects = document.querySelectorAll('.tax-rate-select');
  taxSelects.forEach((select) => {
    select.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      const value = target.value;

      // Find the corresponding input field
      const formId = target.id.replace('-select', '');
      const input = document.getElementById(formId) as HTMLInputElement;

      if (input && value) {
        input.value = value;
      }
    });
  });

  // Handle discount select dropdowns
  const discountSelects = document.querySelectorAll('.discount-select');
  discountSelects.forEach((select) => {
    select.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      const value = target.value;

      // Find the corresponding input field
      const formId = target.id.replace('-select', '-rate');
      const input = document.getElementById(formId) as HTMLInputElement;

      if (input && value) {
        input.value = value;
      }
    });
  });

  // Handle tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const type = tab.getAttribute('data-type') as PercentageCalculationType;

      // Update tabs
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      // Update forms
      forms.forEach(f => f.classList.remove('active'));
      const targetForm = document.getElementById(`form-${type}`);
      if (targetForm) {
        targetForm.classList.add('active');
      }

      currentType = type;
      results.style.display = 'none';
    });
  });

  // Handle form submissions
  forms.forEach(form => {
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(form as HTMLFormElement);
      const value1 = parseFloat(formData.get('value1') as string);
      const value2String = formData.get('value2') as string;
      const value2 = value2String ? parseFloat(value2String) : undefined;

      const input: PercentageInput = {
        calculationType: currentType,
        value1,
        value2,
      };

      try {
        const result = calculatePercentage(input);
        displayResults(result);
      } catch (error) {
        alert('Error calculating percentage. Please check your inputs.');
        console.error(error);
      }
    });

    form.addEventListener('reset', () => {
      results.style.display = 'none';
    });
  });

  function displayResults(result: PercentageResult) {
    const resultValue = document.getElementById('result-value') as HTMLParagraphElement;
    const resultExplanation = document.getElementById('result-explanation') as HTMLParagraphElement;
    const resultFormula = document.getElementById('result-formula') as HTMLParagraphElement;

    // Format the result value
    let displayValue = result.result.toString();

    // Add % suffix for percentage results
    if (currentType === 'isWhatPercent' || currentType === 'percentageChange' || currentType === 'percentageDifference') {
      displayValue += '%';
    }
    // Add currency formatting for monetary results
    else if (currentType === 'addTax' || currentType === 'removeTax' || currentType === 'discount' || currentType === 'reverseDiscount') {
      displayValue = result.result.toFixed(2);
    }

    resultValue.textContent = displayValue;
    resultExplanation.textContent = result.explanation;
    resultFormula.textContent = result.formula;

    // Show results
    results.style.display = 'block';
    results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
</script>
